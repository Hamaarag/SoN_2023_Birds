---
title: "Birds_Planted_Forest_analysis_by_plot"
author: "Ron Chen"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# pcks <- list('devtools','rlang','ggplot2','data.table','dplyr','mvabund','kableExtra',
#              'lme4','MASS','vegan','jtools', 'interactions','car','ecoCopula','Cairo',
#              'extrafont', 'emmeans', 'ggrepel')
# sapply(pcks, require, character = TRUE)
library (devtools)
library (rlang)
library (ggplot2)
library (data.table)
library (dplyr)
library (mvabund)
library (kableExtra)
library (lme4)
library (MASS)
library (vegan)
library (jtools)
library (interactions)
library (car)
library (ecoCopula)
library (Cairo)
library (extrafont)
library (ggrepel)
library (emmeans)

source("plot_model_effect.R")
source("prepare_bird_data_with_Z_filter.R")
source("plot_alpha_diversity.R")
source("plot_coefs_with_traits.R")
source("plot_coefs_with_traits_for_publication.R")
source("plot_two_coefs_with_traits.R")
source("plot_two_coefs_with_traits_for_publication.R")
source("multiplot.R")
source("plot_model_interaction.R")

export_all_plots <- TRUE

# if knitting to pdf
#knitr::opts_chunk$set(dev = "cairo_pdf", dev.args=list(cairo_pdf = list(family='Arial')))

# otherwise if knitting to html WITHOUT plot exports
# export_all_plots <- FALSE

knitr::opts_chunk$set(echo = FALSE)

# define font name
SoN_fontname <- "Almoni ML v5 AAA"

# Define the output folder path
output_path <- file.path("..","output", "forest")

# Check if the output folder exists, and create it if it doesn't
if (!dir.exists(output_path)) {
  dir.create(output_path, recursive = TRUE)
  message("Folder '", output_path, "' has been created.")
} else {
  message("Folder '", output_path, "' already exists.")
}
```

```{r load using function}
out <- prepare_bird_data()
var_names <- names(out)
for (i in 1:length(var_names)) {
  assign(var_names[i], out[[i]])
}
rm(out)
P <- P_byplot[grepl("Forest",unit),][order(year,site)][,site:=factor(site)][,subunit:=factor(subunit)]
P_no_rare <- P_byplot_no_rare[grepl("Forest",unit),][order(year,site)][,subunit:=factor(subunit)]
```

## Planted Conifer Forest

Unit is divided into 3 subunits: Judea, Carmel and Galilee.
Only factors is time. All plots are located far from settlements.
Sampling started in spring 2014.
Total 5 campaigns, 3 subunits per campaign, 5 sites per subunit, with 3 plots per site. Total of 45 plots per campaign, and 225 plot-campaign combinations.

**Raw data**
Total abundance: `r Araw[grepl("Forest",unit),sum(total_count)]`
Number of observations: `r Araw[grepl("Forest",unit),.N]`
Total richness: `r Araw[grepl("Forest",unit),uniqueN(SciName)]`

**Filtered data**
Total abundance: `r A[grepl("Forest",unit),sum(count_under_250)]`
Number of observations: `r A[grepl("Forest",unit) & count_under_250>0,.N]`
Total richness: `r A[grepl("Forest",unit) & count_under_250>0,uniqueN(SciName)]`

### Model gma, abundance and richness

Richness done *with* rare species.
Abundance and mean abundance done *without* rare species.
Full models include cosine and sine of the time difference from June 21st (in radians).

#### richness

Explore data.

```{r richness data explore}
# include rare species in analysis
P.anal <- copy(P) # set a fixed variable name for analysis, if want to switch between data WITH rare species and data WITHOUT rare species then only change once here
print("RICHNESS WITH RARE SPECIES")
plot_alpha_diversity(P.anal, x_val = "subunit", y_val = "richness", ylab_val = "richness", xlab_val = "subunit")

dotchart(P.anal$richness, groups = P.anal$subunit, pch = as.numeric(P.anal$subunit), ylab = "subunit", xlab = "richness")
IVs <- c("richness", "year_ct","site","subunit", "td_sc", "cos_td_rad", "sin_td_rad", "h_from_sunrise", "cos_hsun", "sin_hsun", "monitors_name",
                        "wind", "precipitation", "temperature", "clouds")
kable(summary(P.anal[,..IVs]))%>% kable_styling(font_size = 11)
```

no observation for all 4 weather variables.
many NAs for sampling time of day variables.exclude from model.
An extreme observation of richness>20 in Judean highlands near settlements.

```{r richness data explore 3}
pairs(P.anal[,lapply(X = .SD,FUN = as.numeric),.SDcols=IVs[1:10]])
kable(cor(P.anal[,lapply(X = .SD,FUN = as.numeric),.SDcols=IVs[1:10]], use = "pairwise.complete.obs")) %>% kable_styling(font_size = 11)
```

Fit Poisson glm, check for existence of overdispersion

```{r model specification richness, warning=FALSE}
mdl_r.poiss.int <- glm(data = P.anal, formula = richness ~ subunit * year_ct +  cos_td_rad + sin_td_rad , family = poisson)
od <- mdl_r.poiss.int$deviance/mdl_r.poiss.int$df.residual
print("Estimating overdispersion parameter phi: (Res. Dev.)/(n-p) where n=number of observations; p=number of parameters in the model.")
print(paste0('od = ',od))
```

Overdispersion parameter is < 1. Choose Poisson.

```{r model specification richness 2}
m0 <- mdl_r.poiss.int
me0 <- glmer(data = P.anal, formula =  richness ~ subunit*year_ct + cos_td_rad + sin_td_rad + (1|site), family = poisson)
#me1 <- glmer(data = P.anal, formula =  richness ~ year_ct + cos_td_rad + sin_td_rad + (1|subunit), family = poisson)
#me2 <- glmer(data = P.anal, formula =  richness ~ year_ct + cos_td_rad + sin_td_rad + (1|subunit/site), family = poisson)
```

go with mixed model with subunits as a fixed effect (want to make statement about subunits), attempt model selection yet.

```{r model specification richness 3}
summary(me0)
```

perform stepwise model selection of poisson mixed model.

```{r model selection richness}
drop1(me0)
```

remove subunit X year.

```{r model selection richness 2}
me1 <- glmer(data = P.anal, formula =  richness ~ subunit + year_ct + cos_td_rad + sin_td_rad + (1|site), family = poisson)
drop1(me1)
```

drop year.

```{r model selection richness 3}
me1 <- glmer(data = P.anal, formula =  richness ~ subunit+ cos_td_rad + sin_td_rad + (1|site), family = poisson)
drop1(me1)
```

drop subunit.

```{r model selection richness 4}
me1 <- glmer(data = P.anal, formula =  richness ~ cos_td_rad + sin_td_rad + (1|site), family = poisson)
drop1(me1)
```

drop sine.

```{r model selection richness 5}
me1 <- glmer(data = P.anal, formula =  richness ~ cos_td_rad + (1|site), family = poisson)
drop1(me1)
```


only time of year remains.
Final model:

```{r model selection richness 6}
summary(me1)
ranef(me1)
dotplot(ranef(me1, condVar=TRUE))
plot(me1)
qqmath(me1)
# scale location plot
plot(me1, sqrt(abs(resid(.))) ~ fitted(.),
     type = c("p", "smooth"),
     main="scale-location",
     par.settings = list(plot.line =
                           list(alpha=1, col = "red",
                                lty = 1, lwd = 2)))
```

attempt to add year, see if significant:

```{r model selection richness 7}
summary(glmer(data = P.anal, formula =  richness ~ year_ct + cos_td_rad + (1|site), family = poisson))
```

year not significant, rightfully dropped.

**No statistically significant effects of subunit or time found for richness.**

#### geometric mean of abundance

Explore data.
Exclude time of day because of high number of NAs.

```{r gma data explore}
# exclude rare species in analysis
P.anal <- copy(P_no_rare)

print("GEOMETRIC MEAN ABUNDANCE WITHOUT RARE SPECIES")
plot_alpha_diversity(P.anal, x_val = "subunit", y_val = "gma", ylab_val = "gma", xlab_val = "subunit")

dotchart(P.anal$gma, groups = P.anal$subunit, pch = as.numeric(P.anal$subunit), ylab = "subunit", xlab = "gma")
IVs <- c("gma", "year_ct","site","settlements","subunit", "td_sc", "cos_td_rad", "sin_td_rad")
kable(summary(P.anal[,..IVs]))%>% kable_styling(font_size = 11)
```

Fit glm, compare gamma, gaussian (poisson inappropriate because response is not discrete)

```{r model specification gma, warning=FALSE}
mdl_g.gamma.int <- glm(data = P.anal, formula = gma ~ subunit*year_ct + cos_td_rad + sin_td_rad, family = Gamma) # run this if there are no zeros
plot(mdl_g.gamma.int,which = 1:3,sub.caption = "gamma")
mdl_g.gauss.int <- glm(data = P.anal, formula = gma ~ subunit*year_ct + cos_td_rad + sin_td_rad, family = gaussian)
plot(mdl_g.gauss.int,which = 1:3,sub.caption = "gaussian")
```

Remove rows 67, 112.

```{r}
P.anal <- P.anal[!c(67,112)]
```

Fit fixed and mixed models.

```{r model specification gma 2}
m0 <- glm(data = P.anal, formula = gma ~ subunit*year_ct + cos_td_rad + sin_td_rad, family = Gamma)
me0 <- glmer(data = P.anal, formula =  gma ~ subunit*year_ct + cos_td_rad + sin_td_rad + (1|site), family = Gamma)
```

Mixed model did not converge, attempt model selection.

```{r model specification gma 3}
summary(me0)
```

perform stepwise model selection of gaussian model.

```{r model selection gma}
drop1(me0)
```

drop year : subunit

```{r}
me1 <- glmer(data = P.anal, formula =  gma ~ subunit + year_ct + cos_td_rad + sin_td_rad + (1|site), family = Gamma)
drop1(me1)
```

drop year

```{r}
me1 <- glmer(data = P.anal, formula =  gma ~ subunit + cos_td_rad + sin_td_rad + (1|site), family = Gamma)
drop1(me1)
```

drop sine

```{r}
me1 <- glmer(data = P.anal, formula =  gma ~ subunit + cos_td_rad + (1|site), family = Gamma)
drop1(me1)
```

drop cosine.

```{r}
me1 <- glmer(data = P.anal, formula =  gma ~ subunit+ (1|site), family = Gamma)
drop1(me1)
```

Only subunit remains.
This is the final model:

```{r model selection gma 2}
summary(me1)
ranef(me1)
dotplot(ranef(me1, condVar=TRUE))
plot(me1)
qqmath(me1)
# scale location plot
plot(me1, sqrt(abs(resid(.))) ~ fitted(.),
     type = c("p", "smooth"),
     main="scale-location",
     par.settings = list(plot.line =
                           list(alpha=1, col = "red",
                                lty = 1, lwd = 2)))
```


```{r model interpretation gma}
summ(me1)

effect_plot(model = me1, data=P.anal, pred = subunit, interval = T, plot.points = TRUE, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = FALSE, colors = 'Qual1', main.title = "", line.colors = 'black', point.alpha = 0.25)
                                     
effplot_subunit <- plot_model_effect(P.anal = P.anal, m = me1, eff2plot = "subunit", plot_points = TRUE, export_plot = export_all_plots, fontname = SoN_fontname, outpath = output_path)

# test the pairwise differences among levels
emm <- emmeans(object = me1, specs = ~subunit)
print(emm)
#Carmel-Galilee
((1/(0.334))/(1/(0.467)) - 1) * 100
#Carmel-Judea 
((1/(0.334)/(1/(0.403))) - 1) * 100
#Judea-Galilee
((1/(0.403)/(1/(0.467))) - 1) * 100

test_results_subunit <- test(pairs(emm), by=NULL, adjust="fdr")
kable(test_results_subunit)
```

**GMA is significantly different among all three subunits, with the highest being Carmel and the lowest Galilee (post-hoc z-test for pairwise contrasts, fdr correction for 3 tests). No significant temporal trend.**

#### abundance

Explore data

```{r abundance data explore}
# exclude rare species in analysis
P.anal <- copy(P_no_rare)

print("ABUNDANCE WITHOUT RARE SPECIES")
plot_alpha_diversity(P.anal, x_val = "subunit", y_val = "abundance", ylab_val = "abundance", xlab_val = "subunit")

dotchart(P.anal$abundance, groups = P.anal$subunit, pch = as.numeric(P.anal$subunit), ylab = "subunit", xlab = "abundance")
IVs <- c("abundance", "year_ct","site","settlements","subunit", "td_sc", "cos_td_rad", "sin_td_rad")
kable(summary(P.anal[,..IVs]))%>% kable_styling(font_size = 11)
```

Two outliers with total abundance >50. Examine:

```{r abundance data explore 2}
P.anal[abundance>50,.(subunit,point_name,datetime,monitors_name,richness,gma,abundance)]
```

Keep all plots for now.

```{r model specification abundance, warning=FALSE, eval=FALSE}
mdl_a.po <- glm(data = P.anal, formula = abundance ~ subunit*year_ct + cos_td_rad + sin_td_rad, family = poisson)
od <- mdl_a.po$deviance/mdl_a.po$df.residual
print("Estimating overdispersion parameter phi: (Res. Dev.)/(n-p) where n=number of observations; p=number of parameters in the model.")
print(paste0('od = ',od))
plot(mdl_a.po,which = 1:2,sub.caption = "poisson")
```

PHI>1, hence choose negative binomial.
Fit fixed and mixed models.
Choose mixed model if possible, otherwise choose a model with fixed-effects only.

```{r model specification abundance 2}
m0 <- glm.nb(data = P.anal, formula = abundance ~ subunit*year_ct + cos_td_rad + sin_td_rad)
me0 <- glmer.nb(data = P.anal, formula =  abundance ~ subunit*year_ct + cos_td_rad + sin_td_rad + (1|site))
```

mixed model failed to converge, attempt model selection of mixed model and see if eventually it converges.

```{r model selection abundance}
drop1(me0)
```

drop subunit X year

```{r model selection abundance 2}
me1 <- glmer.nb(data = P.anal, formula =  abundance ~ subunit + year_ct + cos_td_rad + sin_td_rad + (1|site))
drop1(me1)
```

drop year

```{r}
me1 <- glmer.nb(data = P.anal, formula =  abundance ~ subunit + cos_td_rad + sin_td_rad + (1|site))
drop1(me1)
```

drop sine because $\Delta AIC<2$

```{r}
me1 <- glmer.nb(data = P.anal, formula =  abundance ~ subunit + cos_td_rad+ (1|site))
drop1(me1)
```

subunit and time of year remain.
The final model:

```{r model selection abundance 3}
summary(me1)
ranef(me1)
dotplot(ranef(me1, condVar=TRUE))
plot(me1)
qqmath(me1)
# scale location plot
plot(me1, sqrt(abs(resid(.))) ~ fitted(.),
     type = c("p", "smooth"),
     main="scale-location",
     par.settings = list(plot.line =
                           list(alpha=1, col = "red",
                                lty = 1, lwd = 2)))
```

Interpretation of abundance model:

```{r model interpretation abundance, warning=FALSE}
summ(me1,exp=T,digits=3)

effplot_subunit <- plot_model_effect(P.anal = P.anal, m = me1, eff2plot = "subunit", plot_points = TRUE, export_plot = export_all_plots, fontname = SoN_fontname, outpath = output_path)
# test the pairwise differences among levels
emm <- emmeans(object = me1, specs = ~subunit)
print(emm)

emmdt <- as.data.table(emm)
emmdt[,exp_emmean:=exp(emmean)]

#Carmel-Galilee
(exp(3.042848)/exp(2.487855)) - 1
#Carmel-Judea
(exp(3.042848)/exp(2.898771)) - 1
#Judea-Galilee
(exp(2.898771)/exp(2.487855)) - 1

iv_subu_jud_gal_abs <- emmdt[grepl("Judean",subunit),exp_emmean]-emmdt[grepl("Galil",subunit),exp_emmean]
iv_subu_jud_gal_rel <- iv_subu_jud_gal_abs/emmdt[grepl("Galil",subunit),exp_emmean]*100
iv_subu_car_gal_abs <- emmdt[grepl("Carmel",subunit),exp_emmean]-emmdt[grepl("Galil",subunit),exp_emmean]
iv_subu_car_gal_rel <- iv_subu_car_gal_abs/emmdt[grepl("Galil",subunit),exp_emmean]*100

test_results_subunit <- test(pairs(emm), by=NULL, adjust="fdr")
kable(test_results_subunit)

m_coef <- fixef(me1)
X <- unique(data.table(samp_date = as_date(as.duration(P.anal$timediff_Jun21+172)), contrib = exp(m_coef["cos_td_rad"]*P.anal$cos_td_rad))[order(samp_date)])
plot(X$samp_date, X$contrib,xlab = "time of year", ylab = "Effect on abundance (multiplier)", type = "b")
```

**significantly lower abundance in Galilee subunit compared to other two subunits (z-test post-hoc with fdr correction for 3 tests). No significant temporal trend.**

Carmel and Judean highland plots have on average `r iv_subu_car_gal_abs` and `r iv_subu_jud_gal_abs` individuals more than Galilee plots, which is `r iv_subu_car_gal_rel` and `r iv_subu_jud_gal_abs` percent higher, respectively.

#### community analysis using package MVabund

```{r explore single observations}
abu_by_spp.forest <- abu_by_spp[grepl("Forest",unit),]
abu_by_spp_no_rare.forest <- abu_by_spp_no_rare[grepl("Forest",unit),]

spp <- abu_by_spp.forest[,.SD[,(length(col_names)+1):ncol(abu_by_spp.forest)]]
# filter out species with zero counts (were either not observed or are rare and were excluded)
spp <- spp[,.SD,.SDcols = colSums(spp)>0]
spp <- mvabund(spp)

spp_no_rare <- abu_by_spp_no_rare.forest[,.SD[,(length(col_names)+1):ncol(abu_by_spp_no_rare.forest)]]
# filter out species with zero counts (were either not observed or are rare and were excluded)
spp_no_rare <- spp_no_rare[,.SD,.SDcols = colSums(spp_no_rare)>0]
spp_no_rare <- mvabund(spp_no_rare)

env_data <- abu_by_spp_no_rare.forest[pilot==FALSE,..col_names]
env_data[,site:=factor(site)][,subunit:=factor(subunit)]

try(expr = plot(spp ~ abu_by_spp.forest$settlements,overall.main="raw abundances", transformation = "no"))
try(plot(spp ~ abu_by_spp.forest$subunit,overall.main="raw abundances", transformation = "no"))

plot(sort(spp_no_rare[spp_no_rare>0]))
dotchart(sort(A[grepl("Forest",unit) & count_under_250>=30,count_under_250]))
meanvar.plot(spp, xlab = "mean abundance of a given species across sites", ylab = "variance of the abundance of a given species across sites")
```

Mean-variance plot: there is a strong relationship, indicating that employing GLMs is the proper way to analyze, rather than OLS (assumption of homogeneity is violated).
start model specification:

```{r community analysis MVabund model specification}
mva_m0.po <- manyglm(formula = spp_no_rare ~ subunit*year_ct + cos_td_rad + sin_td_rad, family = "poisson", data = env_data)
mva_m0.nb <- manyglm(formula = spp_no_rare ~ subunit*year_ct + cos_td_rad + sin_td_rad, family = "negative.binomial", data = env_data)
aic_dt <- data.table(nb = mva_m0.nb$aic, po=mva_m0.po$aic)
colMeans(aic_dt)
print("POISSON")
plot(mva_m0.po, which=1:3)
print("NEGATIVE BINOMIAL")
plot(mva_m0.nb, which=1:3)
```

negative binomial model is better than poisson according to residuals and AIC comparison.

```{r community analysis MVabund model specification 2}
mva_m0 <- mva_m0.nb
mva_m1 <- manyglm(formula = spp_no_rare ~ subunit*year_ct + cos_td_rad + sin_td_rad +site, data = env_data)
aic_dt$nb1 <- mva_m1$aic
colMeans(aic_dt)
```

The addition of the explanatory variable 'site' is improving the AIC of the model.
stepwise selection of model:

```{r community analysis MVabund model selection}
drop1(mva_m1)
```

final model includes year, subunit, subunit X year, sampling time of year.

```{r community analysis MVabund model validation}
plot(mva_m1, which=1:3)
```

```{r community analysis MVabund model interpretation}
#summ_m1 <- summary(mva_m1)
#saveRDS(summ_m1, file = "../output/Forest_MVabund_summary_output_999iter.rds")
#anov_m1.uni <- anova(mva_m1, p.uni = "adjusted", nBoot = 99, show.time = "all")
#saveRDS(anov_m1.uni, file = "../output/Forest_MVabund_anova_output_99iter.rds")
summ_m1 <- readRDS(file = "../output/Forest_MVabund_summary_output_999iter.rds")
anov_m1.uni <- readRDS("../output/Forest_MVabund_anova_output_99iter.rds")
print(summ_m1)
print(anov_m1.uni)
```

### Exmaine the effect of the interaction of year with subunit on individual species:


```{r community analysis MVabund model interpretation - plot coefficients}
coefp <- merge(data.table(t(coef(mva_m1)/log(2)),keep.rownames=TRUE), data.table(t(anov_m1.uni$uni.p), keep.rownames = TRUE), by = "rn") # coefficients are on log2 scale to simplify interpretation, yet keep presenetation on log scale rather than linear. The link function used for poisson is log -> above 0 is a positive trend and below 0 is negative trend

# add total species abundance
coefp <- merge(coefp,as.data.table(colSums(spp_no_rare),keep.rownames = TRUE), by.x = "rn", by.y = "V1")

# add hebrew name and traits
sci_heb <- unique(A[,.(SciName,HebName)])
sci_heb[,SciName:=make.names(SciName)]
coefp <- merge(coefp, sci_heb, by.x = "rn", by.y = "SciName")

# set column names based on the predictor variables
colnames(coefp)[grepl("rn",colnames(coefp))] <- "SciName"
colnames(coefp)[grepl("Intercept).x",colnames(coefp))] <- "intercept.coef"
colnames(coefp)[grepl("Intercept).y",colnames(coefp))] <- "intercept.p"
colnames(coefp)[colnames(coefp)=="settlementsNear"] <- "settlementsNear.coef"
colnames(coefp)[colnames(coefp)=="settlements"] <- "settlements.p"
colnames(coefp)[grepl("cos_td_rad.x",colnames(coefp))] <- "cos_td_rad.coef"
colnames(coefp)[colnames(coefp)=="cos_td_rad.y"] <- "cos_td_rad.p"
colnames(coefp)[grepl("sin_td_rad.x",colnames(coefp))] <- "sin_td_rad.coef"
colnames(coefp)[grepl("sin_td_rad.y",colnames(coefp))] <- "sin_td_rad.p"
colnames(coefp)[colnames(coefp)=="year_ct.x"] <- "year_ct.coef"
colnames(coefp)[colnames(coefp)=="year_ct.y"] <- "year_ct.p"
colnames(coefp)[colnames(coefp)=="V2"] <- "species_abundance"
colnames(coefp)[colnames(coefp)=="dunesshifting"] <- "dunesShifting.coef"
colnames(coefp)[colnames(coefp)=="dunes"] <- "dunes.p"
colnames(coefp)[colnames(coefp)=="site"] <- "site.p"
colnames(coefp)[colnames(coefp)=="subunitCarmel"] <- "subunitCarmel.coef"
colnames(coefp)[colnames(coefp)=="subunitGalilee"] <- "subunitGalilee.coef"
colnames(coefp)[colnames(coefp)=="subunit"] <- "subunit.p"
```

### Chloris chloris - ירקון

```{r community analysis MVabund model interpretation - plot coefficients chlchl}
plot_alpha_diversity(P = abu_by_spp.forest, y_val = "Chloris chloris", ylab_val = "Chloris chloris")
d.chloris <- cbind(env_data,data.table(Chloris.chloris = spp_no_rare[,"Chloris.chloris"]))
# this is not the same model as the manyglm, to show the temporal trend better.
m.chloris <- glm.nb(formula = Chloris.chloris ~ subunit * year_ct + cos_td_rad + sin_td_rad + site, data = d.chloris)
coef(mva_m1)[,"Chloris.chloris"]
coef(m.chloris)

plot_model_interaction(P.anal = d.chloris, m = m.chloris, eff2plot = "year_ct", modvar2plot = "subunit", plot_points=FALSE, plot_residuals=FALSE, export_plot=TRUE, ylabel = NULL, fontname = SoN_fontname, fontsize=22, pdf_width=160, outpath = output_path)

chloris_interact <- interact_plot(model=m.chloris, data=d.chloris, pred=year_ct, modx=subunit, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "")


time_carmel <- as.data.table(chloris_interact$data)[subunit=="Carmel",Chloris.chloris]
(1 - min(time_carmel)/max(time_carmel))*100
1 - 0.04069691/1.52509491 

time_galilee <- as.data.table(chloris_interact$data)[subunit=="Galilee",Chloris.chloris]
(max(time_galilee)/min(time_galilee)-1)*100
1.0870104/0.3148136 - 1

time_judea <- as.data.table(chloris_interact$data)[subunit=="Judean Highlands",Chloris.chloris]
(max(time_judea)/min(time_judea)-1)*100
2.869266/1.554558 - 1

emm_year_ct <- emtrends(m.chloris, specs = "subunit", var = "year_ct", type = "response")
print(emm_year_ct)
test_year_ct <- test(emm_year_ct, null=0, adjust="fdr")
print(test_year_ct)
```

### Streptopelia turtur - תור מצוי

```{r community analysis MVabund model interpretation - plot coefficients strtur}
plot_alpha_diversity(P = abu_by_spp.forest, x_val = "settlements", y_val = "Streptopelia turtur", ylab_val = "Streptopelia turtur")
d.strtur <- cbind(env_data,data.table(Streptopelia.turtur = spp_no_rare[,"Streptopelia.turtur"]))
# this is not the same model as the manyglm, to show the temporal trend better.
m.strtur <- glm.nb(formula = Streptopelia.turtur ~ subunit * year_ct + cos_td_rad + sin_td_rad + site, data = d.strtur)
coef(mva_m1)[,"Streptopelia.turtur"]
coef(m.strtur)

plot_model_interaction(P.anal = d.strtur, m = m.strtur, eff2plot = "year_ct", modvar2plot = "subunit", plot_points=FALSE, plot_residuals=FALSE, export_plot=TRUE, ylabel = NULL, fontname = SoN_fontname, fontsize=22, pdf_width=160, outpath = output_path)

strtur_interact <- interact_plot(model = m.strtur, data=d.strtur, pred = year_ct, modx=subunit, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Prinia gracilis")

turtur_carmel <- as.data.table(abu_by_spp.forest)[subunit=="Carmel"]
print(turtur_carmel$`Streptopelia turtur`)

time_carmel <- as.data.table(strtur_interact$data)[subunit=="Carmel",Streptopelia.turtur]
(1 - min(time_carmel)/max(time_carmel))*100
1 - 0.0001766079/1.1725793703 

time_gelilee <- as.data.table(strtur_interact$data)[subunit=="Galilee",Streptopelia.turtur]
(max(time_galilee)/min(time_galilee)-1)*100
0.35843115/0.08201108 - 1

time_judea <- as.data.table(strtur_interact$data)[subunit=="Judean Highlands",Streptopelia.turtur]
(max(time_judea)/min(time_judea)-1)*100
1- 0.1102144/0.6370486 

emm_year_ct <- emtrends(m.strtur, specs = "subunit", var = "year_ct", type = "response")
print(emm_year_ct)
test_year_ct <- test(emm_year_ct, null=0, adjust="fdr")
print(test_year_ct)


```

The effect of subunit interaction with year is not big. There are two species for which this interaction is significant:
For Chloris chloris there are two subunits with opposing trends which are significantly different from zero.
For Streptopelia turtur there is only one subunit with a temporal trend which is significantly different from zero.

**Re-run model without subunit:year interaction and without site for simplification of the interpretation of results**

```{r}
mva_m1 <- manyglm(formula = spp_no_rare ~ subunit + year_ct + cos_td_rad + sin_td_rad, data = env_data)
drop1(mva_m1)
```

drop sine

```{r}
mva_m1 <- manyglm(formula = spp_no_rare ~ subunit + year_ct + cos_td_rad, data = env_data)
drop1(mva_m1)
```

drop cosine

```{r}
mva_m1 <- manyglm(formula = spp_no_rare ~ subunit + year_ct, data = env_data)
drop1(mva_m1)
```

year should be dropped. keep year because difference in AIC is very small (<1)
final model includes subunit and year.

```{r community analysis MVabund model validation2}
plot(mva_m1, which=1:3)
```

```{r community analysis MVabund model interpretation2}
#summ_m3 <- summary(mva_m1)
#saveRDS(summ_m3, file = "../output/Forest_MVabund_year_and_subunit_summary_output_999.rds")
#anov_m3.uni <- anova(mva_m1, p.uni = "adjusted", nBoot = 99, show.time = "all")
#saveRDS(anov_m3.uni, file = "../output/Forest_MVabund_year_and_subunit_anova_output_99.rds")
summ_m3 <- readRDS(file = "../output/Forest_MVabund_year_and_subunit_summary_output_999.rds")
anov_m3.uni <- readRDS("../output/Forest_MVabund_year_and_subunit_anova_output_99.rds")
print(summ_m3)
print(anov_m3.uni)
```

**Factors year and subunit have statistically significant effects on community composition.**

```{r community analysis MVabund model interpretation - plot coefficients2}
coefp <- merge(data.table(t(coef(mva_m1)/log(2)),keep.rownames=TRUE), data.table(t(anov_m3.uni$uni.p), keep.rownames = TRUE), by = "rn") # coefficients are on log2 scale to simplify interpretation, yet keep presenetation on log scale rather than linear. The link function used for poisson is log -> above 0 is a positive trend and below 0 is negative trend

# add total species abundance
coefp <- merge(coefp,as.data.table(colSums(spp_no_rare),keep.rownames = TRUE), by.x = "rn", by.y = "V1")

# add hebrew name and traits
sci_heb <- unique(A[,.(SciName,HebName)])
sci_heb[,SciName:=make.names(SciName)]
coefp <- merge(coefp, sci_heb, by.x = "rn", by.y = "SciName")

# set column names based on the predictor variables
colnames(coefp)[grepl("rn",colnames(coefp))] <- "SciName"
colnames(coefp)[grepl("Intercept).x",colnames(coefp))] <- "intercept.coef"
colnames(coefp)[grepl("Intercept).y",colnames(coefp))] <- "intercept.p"
colnames(coefp)[colnames(coefp)=="settlementsNear"] <- "settlementsNear.coef"
colnames(coefp)[colnames(coefp)=="settlements"] <- "settlements.p"
colnames(coefp)[grepl("cos_td_rad.x",colnames(coefp))] <- "cos_td_rad.coef"
colnames(coefp)[colnames(coefp)=="cos_td_rad.y"] <- "cos_td_rad.p"
colnames(coefp)[grepl("sin_td_rad.x",colnames(coefp))] <- "sin_td_rad.coef"
colnames(coefp)[grepl("sin_td_rad.y",colnames(coefp))] <- "sin_td_rad.p"
colnames(coefp)[colnames(coefp)=="year_ct.x"] <- "year_ct.coef"
colnames(coefp)[colnames(coefp)=="year_ct.y"] <- "year_ct.p"
colnames(coefp)[colnames(coefp)=="V2"] <- "species_abundance"
colnames(coefp)[colnames(coefp)=="dunesshifting"] <- "dunesShifting.coef"
colnames(coefp)[colnames(coefp)=="dunes"] <- "dunes.p"
colnames(coefp)[colnames(coefp)=="site"] <- "site.p"
colnames(coefp)[colnames(coefp)=="subunitCarmel"] <- "subunitCarmel.coef"
colnames(coefp)[colnames(coefp)=="subunitGalilee"] <- "subunitGalilee.coef"
colnames(coefp)[colnames(coefp)=="subunit"] <- "subunit.p"

plot_coefs_with_traits_for_publication(D = A_no_rare[grepl("Planted",unit)],
                                                cp = coefp[,.(SciName,year_ct.coef,year_ct.p,species_abundance)],
                                                plot_title = "Temporal effect on species abundance",
                                                plot_xlabel = expression(paste("coefficient of year counter, (log"[2]," scale)")),
                                                mark_batha = TRUE,
                                                show_legend = FALSE,
                                                export_plot = TRUE,
                                                fontname = SoN_fontname,
                                                effect_str = "year_ct",
                                                outpath = output_path)

plot_coefs_subunit <- plot_two_coefs_with_traits(D = A_no_rare[grepl("Planted",unit)],
                                                 cp = coefp[,.(SciName,coef.x=subunitCarmel.coef,coef.y=subunitGalilee.coef,subunit.p,species_abundance)],
                                                 plot_title = "Effect of subunit on species abundance",
                                                 plot_xlabel = expression(paste("coefficient of Carmel sub-unit (ref: Judean Highlands; log"[2]," scale)")),
                                                 plot_ylabel = expression(paste("coefficient of Galilee sub-unit (ref: Judean Highlands; log"[2]," scale)")),
                                                 mark_batha = TRUE)

plot_coefs_subunit


plot_two_coefs_with_traits_for_publication(D = A_no_rare[grepl("Forest",unit)],
cp = coefp[,.(SciName,coef.x=subunitCarmel.coef,coef.y=subunitGalilee.coef, subunit.p,species_abundance)],
                                     plot_title = "Effect of subunit on species abundance",
                                     plot_xlabel = expression(paste("coefficient of Carmel sub-unit (ref: Judean Highlands; log"[2]," scale)")),
                                     plot_ylabel = expression(paste("coefficient of Galilee sub-unit (ref: Judean Highlands; log"[2]," scale)")),
                                     mark_batha = TRUE,
                                     show_legend = FALSE,
                                                export_plot = TRUE,
                                                fontname = SoN_fontname,
                                                effect_str = "subunit",
                                                outpath = output_path)


```

## Results for individual species

### Streptopelia turtur - תור מצוי

```{r community analysis MVabund model individual species - strtur}
spec_name <- "Streptopelia turtur"
spec_var_name <- "Streptopelia.turtur"
at_list <- NULL
y_cutoff <- NULL
plot_alpha_diversity(P = abu_by_spp.forest, y_val = spec_name, ylab_val = spec_name)
  d <- cbind(env_data,setnames(data.table(spp_no_rare[,spec_var_name]), old = 1, new = spec_var_name))
  d <- d[!(subunit %like% "Judea")]
  d[,subunit:=factor(subunit)]
  m <- glm.nb(formula = paste(spec_var_name,"subunit + year_ct", sep = "~"), data = d)
  print(coef(mva_m1)[,spec_var_name])
  print(coef(m))
  
  print(paste("RESULTS FOR",spec_name))
  print("P-values")
  pdt <- setnames(x = as.data.table(anov_m3.uni$uni.p, keep.rownames = T)[,.SD,.SDcols = c("rn",spec_var_name)], old = 1:2, new = c("term","p"))
  print(pdt)
  
  #Temporal trend----
  if (pdt[term=="year_ct",p<0.1]) {
    plot_time <- effect_plot(data = d, model = m, pred = year_ct, interval = T, plot.points = T, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4,
                             partial.residuals = F, colors = "Qual1", main.title = spec_name, at = at_list)
    plot_time
    plot_model_effect(P.anal = d, m = m, eff2plot = "year_ct", export_plot = TRUE, plot_points = F, fontname = SoN_fontname,
                      outpath = output_path, at_list = at_list)
    time_dt <- as.data.table(plot_time$data)[,..spec_var_name]
    print(paste("change in",spec_name,"abundance over monitoring period:",(time_dt[nrow(time_dt)]-time_dt[1])/time_dt[1] * 100,"%"))
  }
  
    # spatial effect - subunit----
  if (pdt[term=="subunit",p<0.1]) {
    plot_subunit <- effect_plot(data = d, model = m, pred = subunit, interval = T, plot.points = T, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4,
                                partial.residuals = F, colors = "Qual1", main.title = spec_name, at = at_list)
    plot_subunit
    
    plot_model_effect(P.anal = d, m = m, eff2plot = "subunit", export_plot = TRUE, plot_points = T, fontname = SoN_fontname,
                      outpath = output_path, y_cutoff = y_cutoff, at_list = at_list)
    
    # post-hoc: test for pairwise differences in subunits if subunit term is significant
    EMM <- emmeans(object = m, ~ subunit)
    print(EMM)
    EMMdt <- as.data.table(EMM)
    
    print("Carmel vs Galilee (% difference)")
    print((exp(EMMdt[subunit %like% 'Carmel',emmean])/exp(EMMdt[subunit %like% 'Galil',emmean]) - 1) * 100)
    print("Carmel vs Judea (% difference)")
    print((exp(EMMdt[subunit %like% 'Carmel',emmean])/exp(EMMdt[subunit %like% 'Judea',emmean]) - 1) * 100)
    print("Galilee vs Judea (% difference)")
    print((exp(EMMdt[subunit %like% 'Galil',emmean])/exp(EMMdt[subunit %like% 'Judea',emmean]) - 1) * 100)
    
    test_results_subunit <- test(pairs(EMM, by=NULL, adjust="fdr"))
    print(test_results_subunit)
  }
  rm(spec_name)
  rm(spec_var_name)
  rm(d)
  rm(m)
  rm(pdt)
```

### Corvus cornix - עורב אפור

```{r}
plot_alpha_diversity(P = abu_by_spp.forest, x_val = "settlements", y_val = "Corvus cornix", ylab_val = "Corvus cornix")
d.corvus <- cbind(env_data,data.table(Corvus.cornix = spp_no_rare[,"Corvus.cornix"]))
# this is not the same model as the manyglm, to show that the trend is mainly near settlements.
m.corvus <- glm.nb(formula = Corvus.cornix ~ subunit, data = d.corvus)
coef(mva_m1)[,"Corvus.cornix"]
coef(m.corvus)

plot_model_effect(P.anal = d.corvus, m = m.corvus, eff2plot = "subunit", export_plot = TRUE, plot_points = TRUE, fontname = SoN_fontname, outpath = output_path)


corvus_subunit <- effect_plot(data = d.corvus, model = m.corvus, pred = subunit, interval = T, plot.points = T, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "")

corvus_subunit

#emmeans
EMM <- emmeans(object = m.corvus, ~ subunit)
print(EMM)
#Carmel - Galilee
(exp(-0.223)/exp(-0.386) - 1) * 100
#Carmel-Judea 
(exp(-0.223)/exp(-2.120) - 1) * 100
#Galilee-Judea
(exp(-0.386)/exp(-2.120) - 1) * 100

test_results_subunit <- test(pairs(EMM, by=NULL, adjust="fdr"))
print(test_results_subunit)
```

### Curruca melanocephala - סבכי שחור-ראש

```{r}
plot_alpha_diversity(P = abu_by_spp.forest, x_val = "settlements", y_val = "Curruca melanocephala", ylab_val = "Curruca melanocephala")
d.melano <- cbind(env_data,data.table(Curruca.melanocephala = spp_no_rare[,"Curruca.melanocephala"]))
# this is not the same model as the manyglm, to show that the trend is mainly near settlements.
m.melano <- glm.nb(formula = Curruca.melanocephala ~  subunit, data = d.melano)
coef(mva_m1)[,"Curruca.melanocephala"]
coef(m.melano)

plot_model_effect(P.anal = d.melano, m = m.melano, eff2plot = "subunit", export_plot = TRUE, plot_points = TRUE, fontname = SoN_fontname, outpath = output_path)

melano_subunit <- effect_plot(data = d.melano, model = m.melano, pred = subunit, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "")

melano_subunit

#emmeans
EMM <- emmeans(object = m.melano, ~ subunit)
print(EMM)
#Carmel-Galilee
(exp(1.509)/exp(0.511) - 1) * 100
#Judea-Carmel 
(exp(1.532)/exp(1.509) - 1) * 100
#Judea-Galilee
(exp(1.532 )/exp(0.511) - 1) * 100

test_results_subunit <- test(pairs(EMM, by=NULL, adjust="fdr"))
print(test_results_subunit)
```

### Garrulus glandarius - עורבני

```{r}
plot_alpha_diversity(P = abu_by_spp.forest, x_val = "settlements", y_val = "Garrulus glandarius", ylab_val = "Garrulus glandarius")
d.glandarius <- cbind(env_data,data.table(Garrulus.glandarius=spp_no_rare[,"Garrulus.glandarius"]))
# this is not the same model as the manyglm, to show the temporal trend better.
m.glandarius <- glm.nb(formula = Garrulus.glandarius ~ subunit, data = d.glandarius)
coef(mva_m1)[,"Garrulus.glandarius"]
coef(m.glandarius)

plot_model_effect(P.anal = d.glandarius, m = m.glandarius, eff2plot = "subunit", export_plot = TRUE, plot_points = TRUE, fontname = SoN_fontname, outpath = output_path)

glandarius_subunit <- effect_plot(data = d.glandarius, model = m.glandarius, pred = subunit, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "")

glandarius_subunit

#emmeans
EMM <- emmeans(object = m.glandarius, ~ subunit)
print(EMM)
#Carmel-Galilee
(exp(0.307)/exp(-0.821) - 1) * 100
#Carmel-Judea
(exp(0.307)/exp(0.125) - 1) * 100
#Judea-Galilee
(exp(0.125)/exp(-0.821) - 1) * 100
test_results_subunit <- test(pairs(EMM, by=NULL, adjust="fdr"))
print(test_results_subunit)
```

### Prinia gracilis - פשוש

```{r}
plot_alpha_diversity(P = abu_by_spp.forest, x_val = "settlements", y_val = "Prinia gracilis", ylab_val = "Prinia gracilis")
d.prigra <- cbind(env_data,data.table(Prinia.gracilis = spp_no_rare[,"Prinia.gracilis"]))
# this is not the same model as the manyglm, to show the temporal trend better.
m.prigra <- glm.nb(formula = Prinia.gracilis ~  subunit, data = d.prigra)
coef(mva_m1)[,"Prinia.gracilis"]
coef(m.prigra)

plot_model_effect(P.anal = d.prigra, m = m.prigra, eff2plot = "subunit", export_plot = TRUE, plot_points = TRUE, fontname = SoN_fontname, outpath = output_path)

prigra_subunit <- effect_plot(data = d.prigra, model = m.prigra, pred = subunit, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "")

prigra_subunit

#emmeans
EMM <- emmeans(object = m.prigra, ~ subunit)
print(EMM)
#Galilee-Carmel
(exp(-2.015)/exp(-3.624) - 1) * 100
#Judea-Carmel 
(exp(-0.821)/exp(-3.624) - 1) * 100
#Judea-Galilee
(exp(-0.821)/exp(-2.015) - 1) * 100

test_results_subunit <- test(pairs(EMM, by=NULL, adjust="fdr"))
print(test_results_subunit)
```

### Pycnonotus.xanthopygos - בולבול ממושקף

```{r}
plot_alpha_diversity(P = abu_by_spp.forest, x_val = "settlements", y_val = "Pycnonotus xanthopygos", ylab_val = "Pycnonotus xanthopygos")
d.pycno <- cbind(env_data,data.table(Pycnonotus.xanthopygos = spp_no_rare[,"Pycnonotus.xanthopygos"]))
# this is not the same model as the manyglm, to show that the trend is mainly near settlements.
m.pycno <- glm.nb(formula = Pycnonotus.xanthopygos ~ subunit, data = d.pycno)
coef(mva_m1)[,"Pycnonotus.xanthopygos"]
coef(m.pycno)

plot_model_effect(P.anal = d.pycno, m = m.pycno, eff2plot = "subunit", export_plot = TRUE, plot_points = TRUE, fontname = SoN_fontname, outpath = output_path)

pycno_subunit <- effect_plot(data = d.pycno, model = m.pycno, pred = subunit, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "")

pycno_subunit

#emmeans
EMM <- emmeans(object = m.pycno, ~ subunit)
print(EMM)
#Galilee-Carmel
(exp(-2.015)/exp(-3.219) - 1) * 100
#Judea-Carmel 
(exp(-0.386)/exp(-3.219) - 1) * 100
#Judea-Galilee
(exp(-0.386)/exp(-2.015) - 1) * 100

test_results_subunit <- test(pairs(EMM, by=NULL, adjust="fdr"))
print(test_results_subunit)
```

### Streptopelia decaocto - תור צווארון

```{r}
plot_alpha_diversity(P = abu_by_spp.forest, x_val = "settlements", y_val = "Streptopelia decaocto", ylab_val = "Streptopelia decaocto")
d.decaocto <- cbind(env_data,data.table(Streptopelia.decaocto=spp_no_rare[,"Streptopelia.decaocto"]))
# this is not the same model as the manyglm, to show the temporal trend better.
m.decaocto <- glm.nb(formula = Streptopelia.decaocto ~ subunit, data = d.decaocto)
coef(mva_m1)[,"Streptopelia.decaocto"]
coef(m.decaocto)

plot_model_effect(P.anal = d.decaocto, m = m.decaocto, eff2plot = "subunit", export_plot = TRUE, plot_points = TRUE, fontname = SoN_fontname, outpath = output_path)

decaocto_subunit <- effect_plot(data = d.decaocto, model = m.decaocto, pred = subunit, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "")

decaocto_subunit

#emmeans
EMM <- emmeans(object = m.decaocto, ~ subunit)
print(EMM)
#Carmel-Galilee
(exp(1.543)/exp(0.758) - 1) * 100
#Carmel-Judea
(exp(1.543)/exp(1.324) - 1) * 100
#Judea-Galilee
(exp(1.324)/exp(0.758) - 1) * 100

test_results_subunit <- test(pairs(EMM, by=NULL, adjust="fdr"))
print(test_results_subunit)
```

### Turdus merula - שחרור

```{r}
plot_alpha_diversity(P = abu_by_spp.forest, x_val = "settlements", y_val = "Turdus merula", ylab_val = "Turdus merula")
d.merula <- cbind(env_data,data.table(Turdus.merula=spp_no_rare[,"Turdus.merula"]))
# this is not the same model as the manyglm, to show the temporal trend better.
m.merula <- glm.nb(formula = Turdus.merula ~ subunit, data = d.merula)
coef(mva_m1)[,"Turdus.merula"]
coef(m.merula)

plot_model_effect(P.anal = d.merula, m = m.merula, eff2plot = "subunit", export_plot = TRUE, plot_points = TRUE, fontname = SoN_fontname, outpath = output_path)

merula_subunit <- effect_plot(data = d.merula, model = m.merula, pred = subunit, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "")

merula_subunit

#emmeans
EMM <- emmeans(object = m.merula, ~ subunit)
print(EMM)
#Carmel-Galilee
(exp(1.494)/exp(0.836) - 1) * 100
#Carmel-Judea
(exp(1.494)/exp(1.107) - 1) * 100
#Judea-Galilee
(exp(1.107)/exp(0.836) - 1) * 100

test_results_subunit <- test(pairs(EMM, by=NULL, adjust="fdr"))
print(test_results_subunit)


```

```{r export manyglm p-values}
write.csv(coefp[,.(SciName,HebName,year_ct.p, subunit.p)], file = "../output/forest/species_composition_p_values.csv", row.names = F, fileEncoding = "MS-HEBR")
```