---
title: "Birds_Med_Des_Trans_Zone_analysis_by_plot"
author: "Ron Chen"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#knitr::opts_chunk$set(dev = "cairo_pdf", dev.args=list(cairo_pdf = list(family='Arial')))

# pcks <- list('devtools','rlang','ggplot2','data.table', 'dplyr','mvabund','kableExtra','lme4','MASS','vegan',
#              'jtools', 'interactions','car','ecoCopula','ggrepel','emmeans', 'Cairo')
# sapply(pcks, require, character = TRUE)
library (devtools)
library (rlang)
library (ggplot2)
library (data.table)
library (dplyr)
library (mvabund)
library (kableExtra)
library (lme4)
library (MASS)
library (vegan)
library (jtools)
library (interactions)
library (car)
library (ecoCopula)
library (ggrepel)
library (emmeans)
library (Cairo)
library (extrafont)

source("plot_model_effect.R")
source("prepare_bird_data_with_Z_filter.R")
source("plot_alpha_diversity.R")
source("plot_coefs_with_traits.R")
source("plot_coefs_with_traits_for_publication.R")
source("multiplot.R")
source("plot_model_interaction.R")
# source_url("https://raw.githubusercontent.com/ronchen1/ron_functions/d2d0bab4dc65f29e53d316ae4098d0469711905b/R/multiplot.R")

# define font name
SoN_fontname <- "Almoni ML v5 AAA"

# Define the output folder path
output_path <- file.path("..","output", "md_zone")

# Check if the output folder exists, and create it if it doesn't
if (!dir.exists(output_path)) {
  dir.create(output_path, recursive = TRUE)
  message("Folder '", output_path, "' has been created.")
} else {
  message("Folder '", output_path, "' already exists.")
}
```

```{r load using function}
out <- prepare_bird_data()
var_names <- names(out)
for (i in 1:length(var_names)) {
  assign(var_names[i], out[[i]])
}
rm(out)
P <- P_byplot[grepl("Trans",unit),][order(year,site)][,site:=factor(site)]
P_no_rare <- P_byplot_no_rare[grepl("Trans",unit),][order(year,site)]
```

## Med-Desert Transition Zone

Factors are proximity to settlements and time.
Total 5 campaigns.
5 sites with 6 plots per site.
**Raw data**
Total abundance: `r Araw[grepl("Trans",unit),sum(total_count)]`
Number of observations: `r Araw[grepl("Trans",unit),.N]`
Total richness: `r Araw[grepl("Trans",unit),uniqueN(SciName)]`

**Filtered data**
Total abundance: `r A[grepl("Trans",unit),sum(count_under_250)]`
Number of observations: `r A[grepl("Trans",unit) & count_under_250>0,.N]`
Total richness: `r A[grepl("Trans",unit) & count_under_250>0,uniqueN(SciName)]`


### Model gma, abundance and richness

Richness done *with* rare species.
Abundance and mean abundance done *without* rare species.
Full models include cosine and sine of the time difference from June 21st (in radians).

#### richness

Explore data and plot mean-variance plot.
There is a strong relationship, indicating that employing GLMs is the proper way to analyze, rather than OLS (assumption of homogeneity is violated).

```{r richness data explore}
# include rare species in analysis
P.anal <- copy(P) # set a fixed variable name for analysis, if want to switch between data WITH rare species and data WITHOUT rare species then only change once here
print("RICHNESS WITH RARE SPECIES")
plot_alpha_diversity(P, x_val = "settlements", y_val = "richness", ylab_val = "richness", xlab_val = "settlements")

dotchart(P.anal$richness, groups = P.anal$settlements, pch = as.numeric(P.anal$settlements), ylab = "settlements", xlab = "richness")
IVs <- c("richness", "year_ct","site","settlements", "td_sc", "cos_td_rad", "sin_td_rad", "h_from_sunrise", "cos_hsun", "sin_hsun", "monitors_name",
                        "wind", "precipitation", "temperature", "clouds")
kable(summary(P.anal[,..IVs]))%>% kable_styling(font_size = 11)
```

no observation for all 4 weather variables.
many NAs (61) for sampling time of day variables. exclude from model.

```{r richness data explore 2}
pairs(P.anal[,lapply(X = .SD,FUN = as.numeric),.SDcols=IVs[1:11]])
kable(cor(P.anal[,lapply(X = .SD,FUN = as.numeric),.SDcols=IVs[1:11]], use = "pairwise.complete.obs")) %>% kable_styling(font_size = 11)
```

Fit Poisson glm, check for existence of overdispersion

```{r model specification richness, warning=FALSE}
mdl_r.poiss.int <- glm(data = P.anal, formula = richness ~ settlements * year_ct + cos_td_rad + sin_td_rad , family = poisson)
od <- mdl_r.poiss.int$deviance/mdl_r.poiss.int$df.residual
print("Estimating overdispersion parameter phi: (Res. Dev.)/(n-p) where n=number of observations; p=number of parameters in the model.")
print(paste0('od = ',od))
```

Overdispersion parameter is <1 (underdispersion) and therefore Poisson is preferable to negative binomial.

```{r model specification richness 2}
m0 <- glm(data = P.anal, formula = richness ~ settlements * year_ct + cos_td_rad + sin_td_rad + cos_hsun + sin_hsun, family = poisson)
summ(m0)
```

cosine and sine of hours from sunrise are not significant. remove them because of many NAs.

```{r model specification richness 3}
m0 <- glm(data = P.anal, formula = richness ~ settlements * year_ct + cos_td_rad + sin_td_rad + site, family = poisson)
me0 <- glmer(data = P.anal, formula =  richness ~ settlements * year_ct + cos_td_rad + sin_td_rad + (1|site), family = poisson)
summary(me0)
```

center time of year (cosine and sine) variables - highly correlated with intercept

```{r}
P.anal[,`:=`(cos_td_rad_c=cos_td_rad-mean(cos_td_rad),
             sin_td_rad_c=sin_td_rad-mean(sin_td_rad))]
me1 <- glmer(data = P.anal, formula =  richness ~ settlements * year_ct + cos_td_rad_c + sin_td_rad_c + (1|site), family = poisson)
summary(me1)
```


perform stepwise model selection of poisson mixed model.

```{r model selection richness}
drop1(me1)
```

drop settlements * year.

```{r model selection richness 2}
me1 <- glmer(data = P.anal, formula =  richness ~ settlements + year_ct + cos_td_rad_c + sin_td_rad_c + (1|site), family = poisson)
drop1(me1)
```

drop year.

```{r model selection richness 3}
me1 <- glmer(data = P.anal, formula =  richness ~ settlements + cos_td_rad_c + sin_td_rad_c + (1|site), family = poisson)
drop1(me1)
```

settlements and time of year remain.
Final model:

```{r model selection richness 4}
summary(me1)
ranef(me1)
dotplot(ranef(me1, condVar=TRUE))
plot(me1)
qqmath(me1)
# scale location plot
plot(me1, sqrt(abs(resid(.))) ~ fitted(.),
     type = c("p", "smooth"),
     main="scale-location",
     par.settings = list(plot.line =
                           list(alpha=1, col = "red",
                                lty = 1, lwd = 2)))
```

```{r model interpretation richness}
summ(me1, exp = TRUE, digits = 3)

# when both cosine and sine are in the final model, define their values for plotting, as corresponding to the median of the time difference from June 21

effplot_set <- plot_model_effect(P.anal = P.anal, m = me1, eff2plot = "settlements", export_plot = TRUE, plot_points = TRUE, fontname = SoN_fontname, outpath = output_path)

effplot_set <- effect_plot(model = me1, data=P.anal, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4,
partial.residuals = T, colors = "Qual1", main.title = "effect of proximity to settlements (points are partial residuals)", line.colors = "black", point.alpha = 0.25)
effplot_set$layers[[2]]$geom_params$width <- 0.4

effplot_set$data$richness

#Richness near settlements is 110.4% higher
(max(effplot_set$data$richness)/min(effplot_set$data$richness)-1)*100

iv_set_abs <- diff(effplot_set$data$richness)
iv_set_rel <- iv_set_abs / as.data.table(effplot_set$data)[settlements=="Far",richness] * 100

m_coef <- coef(me1)
X <- unique(data.table(samp_date = as_date(as.duration(P.anal$timediff_Jun21+172)), contrib = exp(m_coef$site[1,"cos_td_rad_c"]*P.anal$cos_td_rad_c + m_coef$site[1,"sin_td_rad_c"]*P.anal$sin_td_rad_c))[order(samp_date)])
plot(X$samp_date, X$contrib,xlab = "time of year", ylab = "Effect on richness (multiplier)", type = "b")

```

**There is a statistically significant effect for proximity to settlements and time of year.**

Near plots have on average `r iv_set_abs` more species than far plots, which is `r iv_set_rel` percent higher.

**No statistically significant effect for the other factors tested.**

#### geometric mean of abundance

Explore data.
Exclude time of day because of high number of NAs.

```{r gma data explore}
# exclude rare species in analysis
P.anal <- copy(P_no_rare)

print("GEOMETRIC MEAN ABUNDANCE WITHOUT RARE SPECIES")
plot_alpha_diversity(P.anal, x_val = "settlements", y_val = "gma", ylab_val = "gma", xlab_val = "settlements")

dotchart(P.anal$gma, groups = P.anal$settlements, pch = as.numeric(P.anal$settlements), ylab = "settlements", xlab = "gma")
IVs <- c("gma", "year_ct","site","settlements", "td_sc", "cos_td_rad", "sin_td_rad")
kable(summary(P.anal[,..IVs]))%>% kable_styling(font_size = 11)
```

Fit glm, compare gamma, gaussian (poisson inappropriate because response is not discrete)

```{r model specification gma, warning=FALSE}
mdl_g.gamma.int <- glm(data = P.anal, formula = gma ~ settlements * year_ct + cos_td_rad + sin_td_rad + site, family = Gamma)
mdl_g.gauss.int <- glm(data = P.anal, formula = gma ~ settlements * year_ct + cos_td_rad + sin_td_rad + site, family = gaussian)
plot(mdl_g.gamma.int,which = 1:3,sub.caption = "gamma")
plot(mdl_g.gauss.int,which = 1:3,sub.caption = "gaussian")
```

Gamma seems better than gaussian.
Remove rows 80 and 19 (1 species with abundance of 5 and 2 species with abundance of 38, respectively).
Fit fixed and mixed models.

```{r model specification gma 2}
P.anal <- P.anal[!c(80,19)]
m0 <- glm(data = P.anal, formula = gma ~ settlements * year_ct + cos_td_rad + sin_td_rad + site, family = Gamma)
me0 <- glmer(data = P.anal, formula =  gma ~ settlements * year_ct + cos_td_rad + sin_td_rad + (1|site), family = Gamma)
```

Mixed model converged:

```{r model specification gma 3}
summary(me0)
```

center time of year (cosine and sine) variables - highly correlated with intercept

```{r}
P.anal[,`:=`(cos_td_rad_c=cos_td_rad-mean(cos_td_rad),
             sin_td_rad_c=sin_td_rad-mean(sin_td_rad))]
me1 <- glmer(data = P.anal, formula =  gma ~ settlements * year_ct + cos_td_rad_c + sin_td_rad_c + (1|site), family = Gamma)
summary(me1)
```

perform stepwise model selection of Gaussian model.

```{r model selection gma}
drop1(me1)
```

drop settlements * year.

```{r model selection gma 2}
me1 <- glmer(data = P.anal, formula =  gma ~ settlements + year_ct + cos_td_rad_c + sin_td_rad_c + (1|site), family = Gamma)
drop1(me1)
```

drop sine of time of year

```{r model selection gma 3}
me1 <- glmer(data = P.anal, formula =  gma ~ settlements + year_ct + cos_td_rad_c + (1|site), family = Gamma)
drop1(me1)
```

drop cosine because $\Delta AIC<2$.

```{r model selection gma 4}
me1 <- glmer(data = P.anal, formula =  gma ~ settlements + year_ct + (1|site), family = Gamma)
drop1(me1)
```

Settlements and year remain.
This is the final model:

```{r model selection gma 5}
summary(me1)
ranef(me1)
dotplot(ranef(me1, condVar=TRUE))
plot(me1)
qqmath(me1)
# scale location plot
plot(me1, sqrt(abs(resid(.))) ~ fitted(.),
     type = c("p", "smooth"),
     main="scale-location",
     par.settings = list(plot.line =
                           list(alpha=1, col = "red",
                                lty = 1, lwd = 2)))
```


```{r model interpretation gma}

summ(me1,digits=3)
effplot_set <- plot_model_effect(P.anal = P.anal, m = me1, eff2plot = "settlements", export_plot = TRUE, plot_points = TRUE, fontname = SoN_fontname, outpath = output_path)

effplot_set <- effect_plot(model = me1, data=P.anal, pred = settlements, interval = T, plot.points = T, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "effect of proximity to settlements (points are observation)", line.colors = "black", point.alpha = 0.25)
effplot_set$layers[[2]]$geom_params$width <- 0.4
 
effplot_set$data$gma

#gma near settlements is 19.05% higher
(max(effplot_set$data$gma)/min(effplot_set$data$gma)-1)*100 

iv_set_abs <- diff(effplot_set$data$gma)
iv_set_rel <- iv_set_abs / as.data.table(effplot_set$data)[settlements=="Far",gma] * 100
plot_model_effect(P.anal = P.anal, m = me1, eff2plot = "year_ct", export_plot = TRUE, plot_points = FALSE, fontname = SoN_fontname, outpath = output_path)

effplot_year <- effect_plot(model = me1, data=P.anal, pred = year_ct, interval = T, plot.points = T, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect (points are observations)", line.colors = "black", point.alpha = 0.25)
effplot_year$layers[[2]]$geom_params$width <- 0.4
iv_year_abs <- as.data.table(effplot_year$data)[,diff(range(gma))/diff(range(year_ct))]

effplot_year$data$gma

#decrease of 42.46% 
(max(effplot_year$data$gma) - min(effplot_year$data$gma))/max(effplot_year$data$gma) * 100
1- 1.614675/2.806445

#or 1.73 fold decline
2.806445/1.614675

```

**Very significant temporal decrease in gma as well as lower gma far from settlements.**

Near plots have on average `r iv_set_abs` more individuals per species than far plots, which is `r iv_set_rel` percent higher.
GMA is decreasing on average in `r iv_year_abs` individuals per species per year.

#### abundance

Explore data

```{r abundance data explore}
# exclude rare species in analysis
P.anal <- copy(P_no_rare)

print("ABUNDANCE WITHOUT RARE SPECIES")
plot_alpha_diversity(P.anal, x_val = "settlements", y_val = "abundance", ylab_val = "abundance", xlab_val = "settlements")

dotchart(P.anal$abundance, groups = P.anal$settlements, pch = as.numeric(P.anal$settlements), ylab = "settlements", xlab = "abundance")
IVs <- c("abundance", "year_ct","site","settlements", "td_sc", "cos_td_rad", "sin_td_rad")
kable(summary(P.anal[,..IVs]))%>% kable_styling(font_size = 11)
```

Outlier with total abundance >80. Examine:

```{r abundance data explore 2}
P.anal[abundance>80]
```

Decided to keep point with abundance of 93 (Lehavim Near 4 from 2012). Nearest total abundances are 72 and 69.

```{r model specification abundance, warning=FALSE, eval=FALSE}
mdl_a.po <- glm(data = P.anal, formula = abundance ~ settlements * year_ct + cos_td_rad + sin_td_rad + site, family = poisson)
od <- mdl_a.po$deviance/mdl_a.po$df.residual
print("Estimating overdispersion parameter phi: (Res. Dev.)/(n-p) where n=number of observations; p=number of parameters in the model.")
print(paste0('od = ',od))
plot(mdl_a.po,which = 1:2,sub.caption = "poisson")
```

PHI>1, hence choose negative binomial.
Fit fixed and mixed models.
Choose mixed model if possible, otherwise choose a model with fixed-effects only.

```{r model specification abundance 2}
m0 <- glm.nb(data = P.anal, formula = abundance ~ settlements * year_ct + cos_td_rad + sin_td_rad + site)
me0 <- glmer.nb(data = P.anal, formula =  abundance ~ settlements * year_ct + cos_td_rad + sin_td_rad + (1|site))
```

Mixed model converged:

```{r model specification abundance 3}
summary(me0)
```

center time of year (cosine and sine) variables - highly correlated with intercept

```{r}
P.anal[,`:=`(cos_td_rad_c=cos_td_rad-mean(cos_td_rad),
             sin_td_rad_c=sin_td_rad-mean(sin_td_rad))]
me1 <- glmer.nb(data = P.anal, formula =  abundance ~ settlements * year_ct + cos_td_rad_c + sin_td_rad_c + (1|site))
summary(me1)
```

Perform stepwise model selection of mixed model.

```{r model selection abundance}
drop1(me1)
```

all terms remain.
The final model:

```{r model selection abundance 2}
summary(me1)
ranef(me1)
dotplot(ranef(me1, condVar=TRUE))
plot(me1)
qqmath(me1)
# scale location plot
plot(me1, sqrt(abs(resid(.))) ~ fitted(.),
     type = c("p", "smooth"),
     main="scale-location",
     par.settings = list(plot.line =
                           list(alpha=1, col = "red",
                                lty = 1, lwd = 2)))
```

Interpretation of abundance model:

```{r model interpretation abundance, warning=FALSE}
summ(me1,digits=3)
intplot_year_set <- plot_model_interaction(P.anal = P.anal, m = me1, eff2plot = "year_ct", modvar2plot = "settlements", plot_points=FALSE, plot_residuals=FALSE, export_plot=TRUE, ylabel = NULL, fontname = SoN_fontname, fontsize=22, pdf_width=160, outpath = output_path, colors = c("#d95f02","#1b9e77"), legend_position = "bottom")

intplot_year_set <- interact_plot(model = me1, data=P.anal, pred = year_ct, modx = settlements, partial.residuals = F, jitter = c(0.2), point.size = 3, rug = F, point.shape = F, interval = T, colors = c("#d95f02","#1b9e77"))

#Near settlements, decrease of 31.12% over time
near_time <- as.data.table(intplot_year_set$data)[settlements=="Near",abundance]
(1-min(near_time)/max(near_time))*100
1-25.82250/37.53772 



#Far from settlements, decrease of 64.21% over time
far_time <- as.data.table(intplot_year_set$data)[settlements=="Far",abundance]
(1-min(far_time)/max(far_time))*100
1 - 5.753485/16.078766


iv_set_abs_start <- as.data.table(intplot_year_set$data)[year_ct==0,diff(abundance)]
iv_set_abs_end <- as.data.table(intplot_year_set$data)[year_ct==max(year_ct),diff(abundance)]
iv_set_rel_start <- iv_set_abs_start / as.data.table(intplot_year_set$data)[settlements=="Near" & year_ct==0,abundance]*100
iv_set_rel_end <- iv_set_abs_end / as.data.table(intplot_year_set$data)[settlements=="Near" & year_ct==max(year_ct),abundance]*100
iv_year_rel_far <- exp(fixef(me1)["year_ct"])
iv_year_rel_near <- exp(fixef(me1)["year_ct"]+fixef(me1)["settlementsNear:year_ct"])

m_coef <- coef(me1)
X <- unique(data.table(samp_date = as_date(as.duration(P.anal$timediff_Jun21+172)), contrib = exp(m_coef$site[1,"cos_td_rad_c"]*P.anal$cos_td_rad_c + m_coef$site[1,"sin_td_rad_c"]*P.anal$sin_td_rad_c))[order(samp_date)])
plot(X$samp_date, X$contrib,xlab = "time of year", ylab = "Effect on abundance (multiplier)", type = "b")

#Temporal trends
emm_year_ct <- emtrends(me1, specs = "settlements", var = "year_ct", type = "response")
print(emm_year_ct)
test_results_year_ct <- test(emm_year_ct, null = 0, adjust = "fdr")
print(test_results_year_ct)

#Means near vs. far
EMM <- emmeans(object = me1, ~settlements*year_ct)
print(EMM)
test_results_land_use <- test(pairs(EMM, by="year_ct"), by=NULL, adjust="fdr")
print(test_results_land_use)

```


**Significant higher abundance near settlements, and stronger relative decrease in total abundance far from settlements:**

On average, a near plot has `r (iv_set_abs_start+iv_set_abs_end)/2` more individuals than a far plot, which is `r (iv_set_rel_start+iv_set_rel_end)/2` percent higher.

The average rate of decrease in abundance far from settlements is NEARLY TRIPLE the rate near settlements, `r (1-iv_year_rel_far)*100` vs. `r (1-iv_year_rel_near)*100`, respectively.


#### community analysis using package MVabund

```{r explore single observations}
abu_by_spp.trans <- abu_by_spp[grepl("Trans",unit),]
abu_by_spp_no_rare.trans <- abu_by_spp_no_rare[grepl("Trans",unit),]

spp <- abu_by_spp.trans[,.SD[,(length(col_names)+1):ncol(abu_by_spp.trans)]]
# filter out species with zero counts (were either not observed or are rare and were excluded)
spp <- spp[,.SD,.SDcols = colSums(spp)>0]
spp <- mvabund(spp)

spp_no_rare <- abu_by_spp_no_rare.trans[,.SD[,(length(col_names)+1):ncol(abu_by_spp_no_rare.trans)]]
# filter out species with zero counts (were either not observed or are rare and were excluded)
spp_no_rare <- spp_no_rare[,.SD,.SDcols = colSums(spp_no_rare)>0]
spp_no_rare <- mvabund(spp_no_rare)

env_data <- abu_by_spp_no_rare.trans[,..col_names]
env_data[,site:=factor(site)]

try(expr = plot(spp ~ abu_by_spp.trans$settlements,overall.main="raw abundances", transformation = "no"))

plot(sort(spp_no_rare[spp_no_rare>0]))
dotchart(sort(A[grepl("Trans",unit) & count_under_250>=30,count_under_250]))
meanvar.plot(spp, xlab = "mean abundance of a given species across sites", ylab = "variance of the abundance of a given species across sites")
```

start model specification:

```{r community analysis MVabund model specification}
mva_m0.po <- manyglm(formula = spp_no_rare ~ settlements * year_ct + cos_td_rad + sin_td_rad, family = "poisson", data = env_data)
mva_m0.nb <- manyglm(formula = spp_no_rare ~ settlements * year_ct + cos_td_rad + sin_td_rad, family = "negative.binomial", data = env_data)
aic_dt <- data.table(nb = mva_m0.nb$aic, po=mva_m0.po$aic)
colMeans(aic_dt)
print("POISSON")
plot(mva_m0.po, which=1:3)
print("NEGATIVE BINOMIAL")
plot(mva_m0.nb, which=1:3)
```

negative binomial model is better than poisson according to residuals and AIC comparison.

```{r community analysis MVabund model specification 2}
mva_m0 <- mva_m0.nb
mva_m1 <- manyglm(formula = spp_no_rare ~ settlements * year_ct + cos_td_rad + sin_td_rad +site, data = env_data)
aic_dt$nb1 <- mva_m1$aic
colMeans(aic_dt)
```

The addition of the explanatory variable 'site' is improving the AIC of the model.
stepwise selection of model:

```{r community analysis MVabund model selection}
drop1(mva_m1)
```

drop cosine.

```{r community analysis MVabund model selection 2}
mva_m1 <- manyglm(formula = spp_no_rare ~ settlements * year_ct + sin_td_rad + site, data = env_data)
drop1(mva_m1)
```

drop interaction of settlements with year.

```{r community analysis MVabund model selection 3}
mva_m1 <- manyglm(formula = spp_no_rare ~ settlements + year_ct + sin_td_rad + site, data = env_data)
drop1(mva_m1)
```

final model includes settlements, year, sampling time of year and site.

```{r community analysis MVabund model validation}
plot(mva_m1, which=1:3)
```

```{r community analysis MVabund model interpretation}
#summ_m1 <- summary(mva_m1)
#saveRDS(summ_m1, file = "../output/20230606_Trans_MVabund_summary_output_999iter.rds")
#anov_m1.uni <- anova(mva_m1, p.uni = "adjusted", nBoot = 99, show.time = "all")
# saveRDS(anov_m1.uni, file = "../output/Trans_MVabund_anova_output_99iter.rds")
summ_m1 <- readRDS(file = "../output/20230606_Trans_MVabund_summary_output_999iter.rds")
anov_m1.uni <- readRDS(file = "../output/Trans_MVabund_anova_output_99iter.rds")
print(summ_m1)
print(anov_m1.uni)
```

**All factors (settlements, year, time of year and site) have a statistically significant effect on community composition.**

```{r community analysis MVabund model interpretation - plot coefficients}
coefp <- merge(data.table(t(coef(mva_m1)/log(2)),keep.rownames=TRUE), data.table(t(anov_m1.uni$uni.p), keep.rownames = TRUE), by = "rn") # coefficients are on log2 scale to simplify interpretation, yet keep presenetation on log scale rather than linear. The link function used for poisson is log -> above 0 is a positive trend and below 0 is negative trend

# add total species abundance
coefp <- merge(coefp,as.data.table(colSums(spp_no_rare),keep.rownames = TRUE), by.x = "rn", by.y = "V1")

# add hebrew name and traits
sci_heb <- unique(A[,.(SciName,HebName)])
sci_heb[,SciName:=make.names(SciName)]
coefp <- merge(coefp, sci_heb, by.x = "rn", by.y = "SciName")

# set column names based on the predictor variables
colnames(coefp)[grepl("rn",colnames(coefp))] <- "SciName"
colnames(coefp)[grepl("Intercept).x",colnames(coefp))] <- "intercept.coef"
colnames(coefp)[grepl("Intercept).y",colnames(coefp))] <- "intercept.p"
colnames(coefp)[colnames(coefp)=="settlementsNear"] <- "settlementsNear.coef"
colnames(coefp)[colnames(coefp)=="settlements"] <- "settlements.p"
colnames(coefp)[grepl("cos_td_rad.x",colnames(coefp))] <- "cos_td_rad.coef"
colnames(coefp)[colnames(coefp)=="cos_td_rad.y"] <- "cos_td_rad.p"
colnames(coefp)[grepl("sin_td_rad.x",colnames(coefp))] <- "sin_td_rad.coef"
colnames(coefp)[grepl("sin_td_rad.y",colnames(coefp))] <- "sin_td_rad.p"
colnames(coefp)[colnames(coefp)=="year_ct.x"] <- "year_ct.coef"
colnames(coefp)[colnames(coefp)=="year_ct.y"] <- "year_ct.p"
colnames(coefp)[colnames(coefp)=="V2"] <- "species_abundance"
colnames(coefp)[colnames(coefp)=="dunesshifting"] <- "dunesShifting.coef"
colnames(coefp)[colnames(coefp)=="dunes"] <- "dunes.p"
colnames(coefp)[colnames(coefp)=="site"] <- "site.p"
colnames(coefp)[colnames(coefp)=="subunitCarmel"] <- "subunitCarmel.coef"
colnames(coefp)[colnames(coefp)=="subunitGalilee"] <- "subunitGalilee.coef"
colnames(coefp)[colnames(coefp)=="subunit"] <- "subunit.p"

 # plot_coefs_settle <- plot_coefs_with_traits(D = A_no_rare[grepl("Trans",unit)],
 #                                      cp = coefp[,.(SciName,settlementsNear.coef,settlements.p,species_abundance)],
 #                                      plot_title = "Effect of proximity to settlements on species abundance",
 #                                     plot_xlabel = expression(paste("coefficient of NEAR settlements, (log"[2]," scale)")),
 #                                      mark_batha = TRUE)

plot_coefs_settle <- plot_coefs_with_traits_for_publication(D = A_no_rare[grepl("Trans",unit)],
                                     cp = coefp[,.(SciName,settlementsNear.coef,settlements.p,species_abundance)],
                                     plot_title = "Effect of proximity to settlements on species abundance",
                                     plot_xlabel = expression(paste("coefficient of NEAR settlements, (log"[2]," scale)")),
                                     mark_batha = TRUE,
                                                show_legend = FALSE,
                                                export_plot = TRUE,
                                                fontname = SoN_fontname,
                                                effect_str = "settlements",
                                                outpath = output_path)

plot_coefs_settle


plot_coefs_year <- plot_coefs_with_traits_for_publication(D = A_no_rare[grepl("Trans",unit)],
                                     cp = coefp[,.(SciName,year_ct.coef,year_ct.p,species_abundance)],
                                     plot_title = "Temporal effect on species abundance",
                                     plot_xlabel = expression(paste("coefficient of year counter, log"[2]," scale)")),
                                     mark_batha = TRUE,
                                                show_legend = FALSE,
                                                export_plot = TRUE,
                                                fontname = SoN_fontname,
                                                effect_str = "year_ct",
                                                outpath = output_path)
plot_coefs_year
```

**Significant effect of settlement proximity: synanthrope / invasive species near settlements, endangered and / or batha specialists far from settlements.**

**Synanthrope local species decreasing while synanthrope invasive species increasing**

**Significant negative temporal effect on crested lark, house sparrow and laughing dove, and positive effect on common myna.**


```{r community analysis MVabund interpretation}
#####Chloris chloris - ירקון#####

plot_alpha_diversity(P = abu_by_spp.trans, x_val = "settlements", y_val = "Chloris chloris", ylab_val = "Chloris chloris")
d.Chloris.chloris <- cbind(env_data,data.table(Chloris.chloris = spp_no_rare[,"Chloris.chloris"]))
m.Chloris.chloris <- glm.nb(formula = Chloris.chloris~settlements + year_ct + sin_td_rad + site, data = d.Chloris.chloris)
coef(mva_m1)[,"Chloris.chloris"]
coef(m.Chloris.chloris)

chloris_set <- effect_plot(model = m.Chloris.chloris, data=d.Chloris.chloris, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Chloris chloris")

chloris_set$data$Chloris.chloris

#abundance near settlements is 1712.1% higher than far 
(max(chloris_set$data$Chloris.chloris)/min(chloris_set$data$Chloris.chloris)-1)*100

#####Galerida cristata - עפרוני מצויץ#####

plot_alpha_diversity(P = abu_by_spp.trans, x_val = "settlements", y_val = "Galerida cristata", ylab_val = "Galerida cristata")
d.Galerida.cristata <- cbind(env_data,data.table(Galerida.cristata = spp_no_rare[,"Galerida.cristata"]))
m.Galerida.cristata <- glm.nb(formula = Galerida.cristata~settlements + year_ct + sin_td_rad + site, data = d.Galerida.cristata)
coef(mva_m1)[,"Galerida.cristata"]
coef(m.Galerida.cristata)

# plot_model_effect(P.anal = d.Galerida.cristata, m = m.Galerida.cristata, eff2plot = "year_ct", export_plot = TRUE, plot_points = FALSE, fontname = SoN_fontname, outpath = output_path)

cristata_time <- effect_plot(model = m.Galerida.cristata, data=d.Galerida.cristata, pred = year_ct, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Galerida cristata")

cristata_time$data$Galerida.cristata

#Decrease of 42.19% over time
(1-min(cristata_time$data$Galerida.cristata)/max(cristata_time$data$Galerida.cristata))*100
1- 1.482529/2.564497

cristata_set <- effect_plot(model = m.Galerida.cristata, data=d.Galerida.cristata, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Galerida cristata")

cristata_set$data$Galerida.cristata

#abundance near settlements is 230.66% higher than far 
(max(cristata_set$data$Galerida.cristata)/min(cristata_set$data$Galerida.cristata)-1)*100
1.9516386 /0.5902138 - 1

#or 3.3 fold
1.9516386 /0.5902138 



#########Spilopelia senegalensis - צוצלת########

plot_alpha_diversity(P = abu_by_spp.trans, x_val = "settlements", y_val = "Spilopelia senegalensis", ylab_val = "Spilopelia senegalensis")
d.Spilopelia.senegalensis <- cbind(env_data,data.table(Spilopelia.senegalensis = spp_no_rare[,"Spilopelia.senegalensis"]))

# this is not the same model as the manyglm, to show the temporal trend better:
#d.Spilopelia.senegalensis <- d.Spilopelia.senegalensis[site!="Dvir"] # exclude this site because the species was not seen there at all.
d.Spilopelia.senegalensis <- d.Spilopelia.senegalensis[settlements=="Near"] # exclude all far observations because the species was not seen there at all.
m.Spilopelia.senegalensis <- glm.nb(formula = Spilopelia.senegalensis~ year_ct + sin_td_rad + site, data = d.Spilopelia.senegalensis)

coef(mva_m1)[,"Spilopelia.senegalensis"]
coef(m.Spilopelia.senegalensis)

# plot_model_effect(P.anal = d.Spilopelia.senegalensis, m = m.Spilopelia.senegalensis, eff2plot = "year_ct", export_plot = TRUE, plot_points = FALSE, fontname = SoN_fontname, outpath = output_path)

senegal_time <- effect_plot(model = m.Spilopelia.senegalensis, data=d.Spilopelia.senegalensis, pred = year_ct, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "")

senegal_time$data$Spilopelia.senegalensis

#Decrase of 94.82% over time
(1-min(senegal_time$data$Spilopelia.senegalensis)/max(senegal_time$data$Spilopelia.senegalensis))*100
1 - 0.2062006/3.9831056

#or 19.31 fold
3.9831056 /0.2062006 


#########Passer domesticus - דרור הבית########

plot_alpha_diversity(P = abu_by_spp.trans, x_val = "settlements", y_val = "Passer domesticus", ylab_val = "Passer domesticus")
d.pasdom <- cbind(env_data,data.table(Passer.domesticus = spp_no_rare[,"Passer.domesticus"]))
m.pasdom <- glm.nb(formula = Passer.domesticus~settlements + year_ct + sin_td_rad + site, data = d.pasdom)
coef(mva_m1)[,"Passer.domesticus"]
coef(m.pasdom)

# plot_model_effect(P.anal = d.pasdom, m = m.pasdom, eff2plot = "year_ct", export_plot = TRUE, plot_points = FALSE, fontname = SoN_fontname, outpath = output_path)

pasdom_time <- effect_plot(model = m.pasdom, data=d.pasdom, pred = year_ct, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")

pasdom_time$data$Passer.domesticus

#Decrease of 96.73% over time
(1-min(pasdom_time$data$Passer.domesticus)/max(pasdom_time$data$Passer.domesticus))*100
1 - 0.1300746/3.9831056  

#or 30.62 fold
3.9831056 /0.1300746

pasdom_set <- effect_plot(model = m.pasdom, data=d.pasdom, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")

pasdom_set$data$Passer.domesticus

#Near settlements 2660.41% higher than far
(max(pasdom_set$data$Passer.domesticus)/min(pasdom_set$data$Passer.domesticus)-1)*100
13.0608517/0.4731487   - 1

#or 27.6 fold
13.0608517 /0.4731487


#####Acridotheres tristis#####

plot_alpha_diversity(P = abu_by_spp.trans, x_val = "settlements", y_val = "Acridotheres tristis", ylab_val = "Acridotheres tristis")
d.acrtri <- cbind(env_data,data.table(Acridotheres.tristis = spp_no_rare[,"Acridotheres.tristis"]))

# this is not the same model as the manyglm, to show the temporal trend better:
d.acrtri <- d.acrtri[settlements=="Near"] # exclude all far observations because the species was not seen there at all.

m.acrtri <- glm.nb(formula = Acridotheres.tristis~ year_ct + sin_td_rad + site, data = d.acrtri)
coef(mva_m1)[,"Acridotheres.tristis"]
coef(m.acrtri)

# plot_model_effect(P.anal = d.acrtri, m = m.acrtri, eff2plot = "year_ct", export_plot = TRUE, plot_points = FALSE, fontname = SoN_fontname, outpath = output_path)

acrtri_eff_time <- effect_plot(model = m.acrtri, data=d.acrtri, pred = year_ct, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Acridotheres tristis")

acrtri_eff_time$data$Acridotheres.tristis

#Increase of 1020.01% over time
(max(acrtri_eff_time$data$Acridotheres.tristis)/min(acrtri_eff_time$data$Acridotheres.tristis)-1)*100
2.3096680/0.2062006 - 1

#or 11.2 fold
2.3096680/0.2062006 

# acrtri_eff_set <- effect_plot(model = m.acrtri, data=d.acrtri, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Acridotheres tristis")
# 
# acrtri_eff_set$data$Acridotheres.tristis
# 
# #abundance near settlements is 1640.7% higher than far 
# 2.64858/0.152156 - 1
# 
# #or 17.4 fold
# 2.64858/0.152156 

########Cinnyris.osea########

plot_alpha_diversity(P = abu_by_spp.trans, x_val = "settlements", y_val = "Cinnyris osea", ylab_val = "Cinnyris osea")
d.cinnyris <- cbind(env_data,data.table(Cinnyris.osea = spp_no_rare[,"Cinnyris.osea"]))
m.cinnyris <- glm.nb(formula = Cinnyris.osea~settlements + year_ct + sin_td_rad + site, data = d.cinnyris)
coef(mva_m1)[,"Cinnyris.osea"]
coef(m.pasdom)

cinnyris_set <- effect_plot(model = m.cinnyris, data=d.cinnyris, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")

cinnyris_set$data$Cinnyris.osea

########Corvus cornix - עורב אפור########

plot_alpha_diversity(P = abu_by_spp.trans, x_val = "settlements", y_val = "Corvus cornix", ylab_val = "Corvus cornix")
d.cornix <- cbind(env_data,data.table(Corvus.cornix = spp_no_rare[,"Corvus.cornix"]))
m.cornix <- glm.nb(formula = Corvus.cornix~settlements + year_ct + sin_td_rad + site, data = d.cornix)
coef(mva_m1)[,"Corvus.cornix"]
coef(m.cornix)

cornix_set <- effect_plot(model = m.cornix, data=d.cornix, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")


#####Turdus merula - שחרור########

plot_alpha_diversity(P = abu_by_spp.trans, x_val = "settlements", y_val = "Turdus merula", ylab_val = "Turdus merula")
d.turdus <- cbind(env_data,data.table(Turdus.merula = spp_no_rare[,"Turdus.merula"]))
m.turdus <- glm.nb(formula = Turdus.merula~settlements + year_ct + sin_td_rad + site, data = d.turdus)
coef(mva_m1)[,"Turdus.merula"]
coef(m.turdus)

cornix_set <- effect_plot(model = m.turdus, data=d.turdus, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")

cornix_set$data$Turdus.merula

#####Garrulus glandarius - עורב שחור כיפה#####

plot_alpha_diversity(P = abu_by_spp.trans, x_val = "settlements", y_val = "Garrulus glandarius", ylab_val = "Garrulus glandarius")
d.garrulus <- cbind(env_data,data.table(Garrulus.glandarius = spp_no_rare[,"Garrulus.glandarius"]))
m.garrulus <- glm.nb(formula = Garrulus.glandarius~settlements + year_ct + sin_td_rad + site, data = d.garrulus)
coef(mva_m1)[,"Garrulus.glandarius"]
coef(m.garrulus)

# garrulus_set <- effect_plot(model = m.garrulus, data=d.garrulus, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")
# 
# garrulus_set$data$Garrulus.glandarius

####Parus major - ירגזי מצוי####

plot_alpha_diversity(P = abu_by_spp.trans, x_val = "settlements", y_val = "Parus major", ylab_val = "Parus major")
d.parus <- cbind(env_data,data.table(Parus.major = spp_no_rare[,"Parus.major"]))
m.parus <- glm.nb(formula = Parus.major ~settlements + year_ct + sin_td_rad + site, data = d.parus)
coef(mva_m1)[,"Parus.major"]
coef(m.parus)

# parus_set <- effect_plot(model = m.parus, data=d.parus, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")
# 
# parus_set$data$Parus.major 

####Vanellus.spinosus - סיקסק####

d.vanellus <- cbind(env_data,data.table(Vanellus.spinosus = spp_no_rare[,"Vanellus.spinosus"]))
m.vanellus <- glm.nb(formula = Vanellus.spinosus ~settlements + year_ct + sin_td_rad + site, data = d.vanellus)
coef(mva_m1)[,"Vanellus.spinosus"]
coef(m.vanellus)

# vanellus_set <- effect_plot(model = m.vanellus, data=d.parus, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")
# 
# vanellus_set$data$Vanellus.spinosus 

####Columba livia - יונת סלעים####

d.Columba <- cbind(env_data,data.table(Columba.livia = spp_no_rare[,"Columba.livia"]))
m.Columba <- glm.nb(formula = Columba.livia ~settlements + year_ct + sin_td_rad + site, data = d.Columba)
coef(mva_m1)[,"Columba.livia"]
coef(m.Columba)

Columba_set <- effect_plot(model = m.Columba, data=d.Columba, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")

Columba_set$data$Columba.livia 

#Near settlements is 3237.16% highern than far
(max(Columba_set$data$Columba.livia )/min(Columba_set$data$Columba.livia )-1)*100
5.0113110/0.1501667 - 1

#or 33.37 fold higher
5.0113110/0.1501667

####Cecropis.daurica - סנונית מערות####

d.cecropis <- cbind(env_data,data.table(Cecropis.daurica = spp_no_rare[,"Cecropis.daurica"]))
m.cecropis <- glm.nb(formula = Cecropis.daurica ~settlements + year_ct + sin_td_rad + site, data = d.cecropis)
coef(mva_m1)[,"Cecropis.daurica"]
coef(m.cecropis)

Columba_set <- effect_plot(model = m.cecropis, data=d.cecropis, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")

Columba_set$data$Cecropis.daurica 

#Near settlements is 3529.7% higher
(max(Columba_set$data$Cecropis.daurica)/min(Columba_set$data$Cecropis.daurica)-1)*100
0.100375562/0.002765395 - 1

#or 36.29 fold higher
0.100375562/0.002765395

####Streptopelia.decaocto - תור צווארון####

d.sterpdeca <- cbind(env_data,data.table(Streptopelia.decaocto = spp_no_rare[,"Streptopelia.decaocto"]))
m.sterpdeca <- glm.nb(formula = Streptopelia.decaocto ~settlements + year_ct + sin_td_rad + site, data = d.sterpdeca)
coef(mva_m1)[,"Streptopelia.decaocto"]
coef(m.sterpdeca)

sterpdeca_set <- effect_plot(model = m.sterpdeca, data=d.sterpdeca, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")

sterpdeca_set$data$Streptopelia.decaocto 

#Near settlements is 1240.46% higher
(max(sterpdeca_set$data$Streptopelia.decaocto )/min(sterpdeca_set$data$Streptopelia.decaocto )-1)*100
1.6979397/0.1266684  - 1

#or 13.4 fold higher
1.6979397/0.1266684 

####Pycnonotus xanthopygos - בולבול ממושקף####

d.pycno <- cbind(env_data,data.table(Pycnonotus.xanthopygos = spp_no_rare[,"Pycnonotus.xanthopygos"]))
m.pycno <- glm.nb(formula = Pycnonotus.xanthopygos ~ settlements + year_ct + sin_td_rad + site, data = d.pycno)
coef(mva_m1)[,"Pycnonotus.xanthopygos"]
coef(m.pycno)

pycno_set <- effect_plot(model = m.pycno, data=d.pycno, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")

pycno_set$data$Pycnonotus.xanthopygos 

#Near settlements is 624.77% higher
(max(pycno_set$data$Pycnonotus.xanthopygos)/min(pycno_set$data$Pycnonotus.xanthopygos)-1)*100
0.38297545/0.05284072   - 1

#or 7.24 fold higher
0.38297545/0.05284072  

####Corvus.monedula - קאק####

d.monedula  <- cbind(env_data,data.table(Corvus.monedula = spp_no_rare[,"Corvus.monedula"]))
m.monedula  <- glm.nb(formula = Corvus.monedula ~ settlements + year_ct + sin_td_rad + site, data = d.monedula)
coef(mva_m1)[,"Corvus.monedula"]
coef(m.monedula)

monedula_set <- effect_plot(model = m.monedula, data=d.monedula, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")

monedula_set$data$Corvus.monedula 

#Near settlements is 511.28% higher
(max(monedula_set$data$Corvus.monedula)/min(monedula_set$data$Corvus.monedula)-1)*100
0.36621389/0.05990911    - 1

#or 6.11 fold higher
0.36621389/0.05990911  


####Streptopelia.turtur - תור מצוי####

d.turtur <- cbind(env_data,data.table(Streptopelia.turtur = spp_no_rare[,"Streptopelia.turtur"]))
m.turtur <- glm.nb(formula = Streptopelia.turtur ~ settlements + year_ct + sin_td_rad + site, data = d.turtur)
coef(mva_m1)[,"Streptopelia.turtur"]
coef(m.turtur)

turtur_set <- effect_plot(model = m.turtur, data=d.turtur, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")

turtur_set$data$Streptopelia.turtur 

#Near settlements is 503.37% highern than far
(max(turtur_set$data$Streptopelia.turtur)/min(turtur_set$data$Streptopelia.turtur)-1)*100
0.055345034/0.009166199  - 1

#or 6.03 fold higher
0.055345034/0.009166199   

####Lanius.senator####

d.lansenator <- cbind(env_data,data.table(Lanius.senator = spp_no_rare[,"Lanius.senator"]))
m.lansenator <- glm.nb(formula = Lanius.senator ~ settlements + year_ct + sin_td_rad + site, data = d.lansenator)
coef(mva_m1)[,"Lanius.senator"]
coef(m.lansenator)

lansenator_set <- effect_plot(model = m.lansenator, data=d.lansenator, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")

lansenator_set$data$Lanius.senator 

#Far from settlements is 438.42% higher 
(max(lansenator_set$data$Lanius.senator)/min(lansenator_set$data$Lanius.senator)-1)*100
0.08315593/0.01544428   - 1

#or 5.38 fold higher
0.08315593/0.01544428    

####Curruca conspicillata - סבכי ערבות#####

d.conspici <- cbind(env_data,data.table(Curruca.conspicillata = spp_no_rare[,"Curruca.conspicillata"]))
m.conspici <- glm.nb(formula = Curruca.conspicillata ~ settlements + year_ct + sin_td_rad + site, data = d.conspici)
coef(mva_m1)[,"Curruca.conspicillata"]
coef(m.conspici)

conspici_set <- effect_plot(model = m.conspici, data=d.conspici, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")

conspici_set$data$Curruca.conspicillata 

#Far from settlements is 1787.36% higher
(max(conspici_set$data$Curruca.conspicillata)/min(conspici_set$data$Curruca.conspicillata)-1)*100
1.30134374 /0.06895049   - 1

#or 18.87 fold higher
1.30134374 /0.06895049  

####Anthus.similis - פפיון הרים####

d.similis <- cbind(env_data,data.table(Anthus.similis = spp_no_rare[,"Anthus.similis"]))
m.similis <- glm.nb(formula = Anthus.similis ~ settlements + year_ct + sin_td_rad + site, data = d.similis)
coef(mva_m1)[,"Anthus.similis"]
coef(m.similis)

similis_set <- effect_plot(model = m.similis, data=d.similis, pred = settlements, interval = T, plot.points = F, jitter = c(0.1,0), point.size = 3, cat.pred.point.size = 4, partial.residuals = F, colors = "Qual1", main.title = "Temporal effect on abundance of Passer domesticus")

similis_set$data$Anthus.similis 

#Far from settlements is 1977.07% higher 
(max(similis_set$data$Anthus.similis)/min(similis_set$data$Anthus.similis)-1)*100
0.56880471/0.02738488   - 1

#or 20.77 fold higher
0.56880471/0.02738488

```

```{r export manyglm p-values}
write.csv(coefp[,.(SciName,HebName,year_ct.p, settlements.p)], file = "../output/md_zone/species_composition_p_values.csv", row.names = F, fileEncoding = "MS-HEBR")
```

### Session information

```{r}
session_info()
```
